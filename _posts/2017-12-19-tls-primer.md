---

---
互联网的通信安全是建立在TLS协议上。

本文主要介绍*为什么HTTPS比传统的HTTP更安全*，以及*如何通过SSL Pinning防止中间人攻击*。



## HTTP vs HTTPS

传统的http通信是**明文**传输，而https是**密文**传输。

HTTPS可以看作是：`HTTPS = HTTP + TLS`



## 什么是TLS

TLS是传输层协议，基本过程包括：

1. 客户端向服务器获取并验证公钥
2. 双方协商生成**对话密钥**
3. 双方使用**对话密钥**加密通信



前两步被称作"握手阶段"。



## 握手阶段

握手阶段，包括：

>1. 客户端向服务器发起请求，传输包含客户端生成的*随机数A*，TLS版本信息以及支持加密算法。
>2. 服务器回应客户端请求，返回包括服务器生成的*随机数B*，*服务器证书*和确认的TLS版本信息以及的加密算法。
>3. 客户端验证证书，通知服务器握手结束，并将生成的**随机数C**用公钥加密后传给服务器。
>4. 服务器通知客户端握手结束。
>5. 双方用商议好的加密方式，使用随机数A，B，C，生成**对话密钥**。



## 中间人攻击

中间人攻击，详见[MITM攻击][]

因为**对话密钥**的安全主要取决于被公钥加密的**随机数C**，所以简单的中间人攻击，通过在握手阶段，篡改服务器证书为受信任的其他证书。



## SSL Pinning

SSL Pinning保证只有客户端允许的证书才能验证通过。通过在app内部事先存入证书相关信息，防止中间人攻击。

SSL Pinning验证方式可以有多种，这里介绍两种：

> 1. 通过证书比对。这种方式比较简单，直接将服务器某级证书如叶节点证书存在app内部，当发起网络请求时，与从服务器得到的证书进行比对，相同，则说明证书没有被篡改。缺点是本地的证书可以在app package的resource下直接看到，可能被修改。
> 2. 通过签名验证。在服务器端对服务器某级证书如叶节点证书加签(注：这里的签名和证书的签名结果是不一样的，证书的签名只是对证书内容的签名)，将结果存在app代码中，当发起网络请求，将得到的服务器证书，公钥和本地的签名三者做签名验证，相同，则说明证书是服务器证书。

相关代码，见[Use SSL Pinning in macOS][](注：由于Charles代理只有二级证书，叶节点证书没办法用自己的，代码中只对root证书验签)

另外，每次服务器证书更新需要及时更新本地证书信息，不然将一直验证失败。



*参考:*

[SSL/TLS协议运行机制的概述](http://www.ruanyifeng.com/blog/2014/02/ssl_tls.html)

[SSL Pinning for Increased App Securtity](https://possiblemobile.com/2013/03/ssl-pinning-for-increased-app-security/)

[MITM攻击]: http://www.jianshu.com/p/a825de42ccbc
[Use SSL Pinning in macOS]: https://github.com/346285234/CQSSLPinning